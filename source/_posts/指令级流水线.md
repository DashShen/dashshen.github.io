---
title: 指令级流水线
date: 2017-11-05 20:01:59
tags: 操作系统
---
在学习内存屏障先关内容的时候，总是会说编译时期的指令重排序或者运行时期的乱序执行，是为了提高运行效率。但是为什么就这样子就可以提高效率呢，停下来翻看一些资料，原来这块的东西居然和指令流水线有关。于是此篇就来讲讲指令流水线，也算是弥补一下研一当年没有听懂的课。

# 指令流水线就是流水线
不要被指令流水线听起来高大上的名字吓到了，其实什么指令流水线和我们说的工厂的流水线是一回事情，工厂中一个产品的装配可以被分成很多个阶段，这样的好处就是在于一个时间段，可以同时进行不同产品的装配。同样的的道理，CPU中的产品就是一条条的指令，指令的执行可以分为很多种不同阶段，比如说我们就可以将这些阶段分为：
* 取指（IF）：从内存中取出一条指令并存放在高速缓存中。
* 指令译码(ID)： 确定指令的操作类型和操作数的地址形成方式。
* 执行指令(EX)：真正执行指令的操作。
* 写操作数(MEM)：访问内存。
* 写寄存器(WB)：结果写回寄存器。

在这里我们将指令分为了五个阶段，称为五级流水线，当然不同的CPU的指令级架构划分指令阶段的方式各不相同，这就和工厂一样，同样是造汽车福特和本田就有可能采用不同的方式来组装的他们的汽车。**每个阶段后面会会跟着一个英文简写，目的是为了方便叙述，可以当做字典，一下子想不起来就可以回到这里看看。**

## 顺序执行与流水线执行
接下来就比较CPU以流水线执行指令和顺序执行指令有什么优势，我们先假设每一个阶段都只需要一个CPU时钟周期就可以完成也不考虑冲突问题。并且有两条指令，这两条指令的执行都需要经过这五个阶段。那么顺序执行的情况就是：
![image](指令级流水线/sequence-flow.png)
可以看到执行两条指令CPU一共花了10个时钟周期，假设一个时钟周期是一秒，也就是说要花10秒才能执行完。如果采用流水线的方式，花费时间就完全不一样了。
![image](指令级流水线/multi-flow.png)
花费时间从原来的10个时钟周期减少到6个时钟周期，仅仅6秒的时间就可以了。这是因为在使用流水线方式执行的时候，同一个时间周期内可以同时执行好几个阶段。比如第二个时间单元，就可以同时执行指令一的译码(ID)和指令二取值(IF)，而在顺序执行时，指令二就必须等到指令一完成之后才能继续执行。

# 指令流水线的影响因素
上面介绍了一下什么是指令流水线，也举了个例子比对了一下指令的顺序执行和流水线式执行的区别。但是其实在显示情况中还有一些因素会影响流水线的流转，导致流水线也不那么的流畅